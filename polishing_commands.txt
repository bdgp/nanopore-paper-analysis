# This file describes the commands used to polish the final assembly for our E. coli paper
# It used nanopolish version tagged as 'paper-v2'

# Run the make pipeline to map the 2D reads (4runs.fa) to the draft assembly (circular.fa)
# This step also generates 'consensus_fast5.fofn' that lets nanopolish find the raw data for each read

make -f consensus.make ASSEMBLY=circular.fa READS=4runs.fa BWA=/mnt/nanopore/nanopore/bwa/bwa 4runs.pp.sorted.bam.bai

# Run nanopolish in parallel, 20 jobs at a time
python nanopolish_makerange.py circular.fa | parallel --results nanopolish.results --colsep ' ' -P 20 python nanopolish.py --contig {1} --segment {2} --assembly circular.fa --bam 4runs.pp.sorted.bam --threads 4

# Merge the overlapping segments to generate the final assembly
python nanopolish_merge.py circular.fa nanopolish_contig* > circular_polished.fa
